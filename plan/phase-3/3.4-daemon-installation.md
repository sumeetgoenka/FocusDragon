# 3.4 Daemon Installation & Management

**Objective:** Create installation process for the LaunchDaemon and integrate with main app.

## Overview

The daemon must be installed to `/Library/Application Support/FocusDragon/` and loaded via `launchctl`. This requires administrator privileges.

## Implementation Steps

### Step 1: Create Installation Script

Create `Scripts/install-daemon.sh`:

```bash
#!/bin/bash

# FocusDragon Daemon Installation Script
set -e

# Paths
DAEMON_SOURCE="$1"
PLIST_SOURCE="$2"
DAEMON_DEST="/Library/Application Support/FocusDragon/FocusDragonDaemon"
PLIST_DEST="/Library/LaunchDaemons/com.focusdragon.daemon.plist"
LOG_DIR="/var/log/focusdragon"

echo "=== FocusDragon Daemon Installation ==="
echo ""

# Check if running as root
if [ "$EUID" -ne 0 ]; then
    echo "Error: This script must be run with sudo"
    exit 1
fi

# Validate arguments
if [ -z "$DAEMON_SOURCE" ] || [ ! -f "$DAEMON_SOURCE" ]; then
    echo "Error: Daemon executable not found: $DAEMON_SOURCE"
    exit 1
fi

if [ -z "$PLIST_SOURCE" ] || [ ! -f "$PLIST_SOURCE" ]; then
    echo "Error: Plist file not found: $PLIST_SOURCE"
    exit 1
fi

# Create directories
echo "Creating directories..."
mkdir -p "/Library/Application Support/FocusDragon"
mkdir -p "$LOG_DIR"

# Copy daemon executable
echo "Installing daemon executable..."
cp "$DAEMON_SOURCE" "$DAEMON_DEST"
chmod 755 "$DAEMON_DEST"
chown root:wheel "$DAEMON_DEST"

# Copy plist
echo "Installing LaunchDaemon plist..."
cp "$PLIST_SOURCE" "$PLIST_DEST"
chmod 644 "$PLIST_DEST"
chown root:wheel "$PLIST_DEST"

# Unload if already loaded (for updates)
if launchctl list | grep -q com.focusdragon.daemon; then
    echo "Unloading existing daemon..."
    launchctl unload "$PLIST_DEST" 2>/dev/null || true
fi

# Load daemon
echo "Loading daemon..."
launchctl load -w "$PLIST_DEST"

# Wait a moment for daemon to start
sleep 2

# Verify daemon is running
if launchctl list | grep -q com.focusdragon.daemon; then
    echo ""
    echo "✅ Daemon installed and running successfully!"
    echo ""
    echo "Daemon path: $DAEMON_DEST"
    echo "Plist path: $PLIST_DEST"
    echo "Logs: $LOG_DIR"
    exit 0
else
    echo ""
    echo "⚠️  Daemon installed but not running"
    echo "Check logs at: $LOG_DIR/daemon-error.log"
    exit 1
fi
```

### Step 2: Create Uninstallation Script

Create `Scripts/uninstall-daemon.sh`:

```bash
#!/bin/bash

# FocusDragon Daemon Uninstallation Script
set -e

PLIST_DEST="/Library/LaunchDaemons/com.focusdragon.daemon.plist"
DAEMON_DIR="/Library/Application Support/FocusDragon"
LOG_DIR="/var/log/focusdragon"

echo "=== FocusDragon Daemon Uninstallation ==="
echo ""

# Check if running as root
if [ "$EUID" -ne 0 ]; then
    echo "Error: This script must be run with sudo"
    exit 1
fi

# Unload daemon
if launchctl list | grep -q com.focusdragon.daemon; then
    echo "Unloading daemon..."
    launchctl unload "$PLIST_DEST" 2>/dev/null || true
fi

# Remove files
echo "Removing files..."
rm -f "$PLIST_DEST"
rm -rf "$DAEMON_DIR"
rm -rf "$LOG_DIR"

# Clean up hosts file
if [ -f /etc/hosts ]; then
    echo "Cleaning hosts file..."
    sed -i '' '/#### FocusDragon Block Start ####/,/#### FocusDragon Block End ####/d' /etc/hosts
fi

echo ""
echo "✅ Daemon uninstalled successfully!"
```

### Step 3: Create DaemonInstaller Helper

Create `FocusDragon/Services/DaemonInstaller.swift`:

```swift
import Foundation

class DaemonInstaller {
    static let shared = DaemonInstaller()

    private let daemonPlistPath = "/Library/LaunchDaemons/com.focusdragon.daemon.plist"

    private init() {}

    // MARK: - Status Check

    func isDaemonInstalled() -> Bool {
        return FileManager.default.fileExists(atPath: daemonPlistPath)
    }

    func isDaemonRunning() -> Bool {
        let task = Process()
        task.launchPath = "/bin/launchctl"
        task.arguments = ["list", "com.focusdragon.daemon"]

        let pipe = Pipe()
        task.standardOutput = pipe
        task.standardError = Pipe()

        try? task.run()
        task.waitUntilExit()

        return task.terminationStatus == 0
    }

    // MARK: - Installation

    func install(completion: @escaping (Result<Void, Error>) -> Void) {
        // Get paths to daemon and plist from bundle
        guard let daemonPath = getDaemonPath(),
              let plistPath = getPlistPath() else {
            completion(.failure(InstallError.resourcesNotFound))
            return
        }

        // Create installation command
        let scriptPath = Bundle.main.path(forResource: "install-daemon", ofType: "sh")!
        let command = """
        do shell script "bash '\(scriptPath)' '\(daemonPath)' '\(plistPath)'" with administrator privileges
        """

        // Execute with admin privileges
        executeAppleScript(command) { success in
            if success {
                completion(.success(()))
            } else {
                completion(.failure(InstallError.installFailed))
            }
        }
    }

    func uninstall(completion: @escaping (Result<Void, Error>) -> Void) {
        let scriptPath = Bundle.main.path(forResource: "uninstall-daemon", ofType: "sh")!
        let command = """
        do shell script "bash '\(scriptPath)'" with administrator privileges
        """

        executeAppleScript(command) { success in
            if success {
                completion(.success(()))
            } else {
                completion(.failure(InstallError.uninstallFailed))
            }
        }
    }

    // MARK: - Update

    func update(completion: @escaping (Result<Void, Error>) -> Void) {
        // Uninstall then install (updates daemon executable)
        uninstall { [weak self] result in
            switch result {
            case .success:
                self?.install(completion: completion)
            case .failure(let error):
                completion(.failure(error))
            }
        }
    }

    // MARK: - Helpers

    private func getDaemonPath() -> String? {
        return Bundle.main.path(forResource: "FocusDragonDaemon", ofType: nil)
    }

    private func getPlistPath() -> String? {
        return Bundle.main.path(forResource: "com.focusdragon.daemon", ofType: "plist")
    }

    private func executeAppleScript(_ script: String, completion: @escaping (Bool) -> Void) {
        DispatchQueue.global().async {
            let task = Process()
            task.launchPath = "/usr/bin/osascript"
            task.arguments = ["-e", script]

            let pipe = Pipe()
            task.standardError = pipe

            do {
                try task.run()
                task.waitUntilExit()

                let success = task.terminationStatus == 0

                DispatchQueue.main.async {
                    completion(success)
                }
            } catch {
                DispatchQueue.main.async {
                    completion(false)
                }
            }
        }
    }

    enum InstallError: LocalizedError {
        case resourcesNotFound
        case installFailed
        case uninstallFailed

        var errorDescription: String? {
            switch self {
            case .resourcesNotFound:
                return "Daemon resources not found in app bundle"
            case .installFailed:
                return "Failed to install daemon. Check permissions."
            case .uninstallFailed:
                return "Failed to uninstall daemon"
            }
        }
    }
}
```

### Step 4: Create Installation UI

Create `FocusDragon/Views/DaemonSetupView.swift`:

```swift
import SwiftUI

struct DaemonSetupView: View {
    @State private var isInstalling = false
    @State private var installError: String?
    @State private var showError = false

    @Environment(\.dismiss) private var dismiss

    var body: some View {
        VStack(spacing: 20) {
            Image(systemName: "gearshape.2.fill")
                .font(.system(size: 60))
                .foregroundColor(.blue)

            Text("Install System Daemon")
                .font(.title)
                .fontWeight(.bold)

            Text("FocusDragon needs to install a background service (daemon) to enforce blocks when the app is closed.")
                .multilineTextAlignment(.center)
                .foregroundColor(.secondary)
                .padding(.horizontal)

            VStack(alignment: .leading, spacing: 10) {
                Label("Runs automatically on startup", systemImage: "checkmark.circle")
                Label("Enforces blocks 24/7", systemImage: "checkmark.circle")
                Label("Protects against tampering", systemImage: "checkmark.circle")
                Label("Requires administrator password", systemImage: "key.fill")
            }
            .foregroundColor(.secondary)

            Spacer()

            HStack(spacing: 20) {
                Button("Skip for Now") {
                    dismiss()
                }
                .buttonStyle(.bordered)

                Button(action: installDaemon) {
                    if isInstalling {
                        ProgressView()
                            .controlSize(.small)
                            .padding(.horizontal)
                    } else {
                        Text("Install Daemon")
                    }
                }
                .buttonStyle(.borderedProminent)
                .disabled(isInstalling)
            }
        }
        .frame(width: 500, height: 400)
        .padding()
        .alert("Installation Error", isPresented: $showError) {
            Button("OK") { }
        } message: {
            Text(installError ?? "Unknown error")
        }
    }

    private func installDaemon() {
        isInstalling = true

        DaemonInstaller.shared.install { result in
            isInstalling = false

            switch result {
            case .success:
                dismiss()
            case .failure(let error):
                installError = error.localizedDescription
                showError = true
            }
        }
    }
}
```

### Step 5: Add to Onboarding

Update onboarding flow to include daemon installation:

```swift
// In OnboardingView
if currentStep == .daemonInstall {
    DaemonSetupView()
}
```

### Step 6: Add Status Indicator

Add daemon status to main view:

```swift
struct DaemonStatusView: View {
    @State private var isRunning = false

    var body: some View {
        HStack {
            Circle()
                .fill(isRunning ? Color.green : Color.red)
                .frame(width: 8, height: 8)

            Text(isRunning ? "Daemon Running" : "Daemon Not Running")
                .font(.caption)
                .foregroundColor(.secondary)

            if !isRunning {
                Button("Install") {
                    // Show daemon setup
                }
                .buttonStyle(.link)
            }
        }
        .onAppear {
            checkStatus()
        }
    }

    private func checkStatus() {
        isRunning = DaemonInstaller.shared.isDaemonRunning()
    }
}
```

## Testing Criteria

### Test 1: Clean Installation
1. Run `sudo bash Scripts/install-daemon.sh <daemon-path> <plist-path>`
2. **Expected:** Success message
3. Check: `launchctl list | grep focusdragon`
4. **Expected:** Daemon is listed and running

### Test 2: Installation from App
1. Click "Install Daemon" in app
2. Enter admin password
3. **Expected:** Installation succeeds
4. **Expected:** Status shows "Daemon Running"

### Test 3: Auto-Start on Boot
1. Install daemon
2. Restart Mac
3. After boot: `launchctl list | grep focusdragon`
4. **Expected:** Daemon is running

### Test 4: Update Installation
1. Install daemon (version 1)
2. Update daemon binary
3. Run installation again
4. **Expected:** Old daemon unloaded, new one loaded

### Test 5: Uninstallation
1. Run `sudo bash Scripts/uninstall-daemon.sh`
2. **Expected:** Success message
3. Check: `launchctl list | grep focusdragon`
4. **Expected:** Not found

### Test 6: Uninstallation from App
1. Install daemon
2. In app settings, click "Uninstall Daemon"
3. **Expected:** Daemon stops and is removed

## Deliverables

✅ Installation script working
✅ Uninstallation script working
✅ DaemonInstaller class in main app
✅ Installation UI
✅ Status checking
✅ Integration with onboarding

## Security Considerations

- Scripts require sudo (admin password)
- Daemon installed to system location
- Only root can modify daemon
- User must explicitly approve installation

## Known Issues

**Issue:** Installation requires password every time
**Impact:** Annoying for updates
**Mitigation:** Document that this is necessary
**Status:** By design (security)

## Next Steps

After Phase 3 completion, you have a fully functional daemon! Move to **Phase 4: Lock Mechanisms** in [../phase-4/4.1-lock-state-management.md](../phase-4/4.1-lock-state-management.md)

## Phase 3 Complete Checklist

- [ ] Daemon compiles and runs
- [ ] Hosts file protection working
- [ ] Process monitoring working
- [ ] Installation script works
- [ ] Daemon auto-starts on boot
- [ ] Status checking in app
- [ ] All tests passing
- [ ] Daemon survives Mac restart

## Estimated Time

**1-2 hours**

**Total Phase 3 Time: 6-8 hours**
