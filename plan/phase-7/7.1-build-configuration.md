# 7.1 Build Configuration & Optimization

**Objective:** Configure release builds with code signing, optimization, and app notarization.

## Overview

Prepare app for distribution with proper code signing, compiler optimizations, and macOS Gatekeeper approval.

## Implementation Steps

### Step 1: Release Build Configuration

Update `FocusDragon.xcodeproj` build settings:

```
Build Configuration: Release

Swift Compiler - Code Generation:
- Optimization Level: Optimize for Speed [-O]
- Compilation Mode: Whole Module

Swift Compiler - Custom Flags:
- Other Swift Flags: -enforce-exclusivity=checked

Apple Clang - Code Generation:
- Optimization Level: Fastest, Smallest [-Os]

Linking:
- Dead Code Stripping: YES
- Strip Debug Symbols: YES
- Strip Swift Symbols: YES

Architectures:
- Architectures: arm64, x86_64 (Universal Binary)
```

### Step 2: Code Signing Configuration

```swift
// Create Developer ID Application certificate
// Sign with hardened runtime

Build Settings:
- Code Signing Identity: Developer ID Application
- Enable Hardened Runtime: YES
- Development Team: YOUR_TEAM_ID

Hardened Runtime Capabilities:
- Disable Library Validation: NO
- Allow DYLD Environment Variables: NO
- Allow Unsigned Executable Memory: NO
- Disable Executable Memory Protection: NO
```

### Step 3: Entitlements

Create `FocusDragon.entitlements`:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>com.apple.security.app-sandbox</key>
    <false/>
    <key>com.apple.security.automation.apple-events</key>
    <true/>
    <key>com.apple.security.files.user-selected.read-write</key>
    <true/>
    <key>com.apple.security.network.client</key>
    <true/>
</dict>
</plist>
```

### Step 4: Build Script

Create `build-release.sh`:

```bash
#!/bin/bash

set -e

echo "Building FocusDragon for release..."

# Clean
xcodebuild clean -project FocusDragon.xcodeproj -scheme FocusDragon

# Build for release
xcodebuild archive \\
    -project FocusDragon.xcodeproj \\
    -scheme FocusDragon \\
    -archivePath "build/FocusDragon.xcarchive" \\
    -configuration Release \\
    CODE_SIGN_IDENTITY="Developer ID Application: YOUR_NAME (TEAM_ID)" \\
    CODE_SIGN_STYLE=Manual

# Export app
xcodebuild -exportArchive \\
    -archivePath "build/FocusDragon.xcarchive" \\
    -exportPath "build/Release" \\
    -exportOptionsPlist ExportOptions.plist

echo "Build complete: build/Release/FocusDragon.app"

# Verify code signing
codesign -vvv --deep --strict "build/Release/FocusDragon.app"

# Check Gatekeeper
spctl -a -vvv "build/Release/FocusDragon.app"
```

Create `ExportOptions.plist`:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>method</key>
    <string>developer-id</string>
    <key>teamID</key>
    <string>YOUR_TEAM_ID</string>
    <key>signingCertificate</key>
    <string>Developer ID Application</string>
</dict>
</plist>
```

### Step 5: Notarization

Create `notarize.sh`:

```bash
#!/bin/bash

set -e

APP_PATH="build/Release/FocusDragon.app"
ZIP_PATH="build/FocusDragon.zip"

# Create ZIP for notarization
ditto -c -k --keepParent "$APP_PATH" "$ZIP_PATH"

# Upload for notarization
xcrun notarytool submit "$ZIP_PATH" \\
    --apple-id "YOUR_APPLE_ID" \\
    --team-id "YOUR_TEAM_ID" \\
    --password "APP_SPECIFIC_PASSWORD" \\
    --wait

# Get submission info
SUBMISSION_ID=$(xcrun notarytool history \\
    --apple-id "YOUR_APPLE_ID" \\
    --team-id "YOUR_TEAM_ID" \\
    --password "APP_SPECIFIC_PASSWORD" \\
    | head -n 2 | tail -n 1 | awk '{print $1}')

# Staple notarization ticket
xcrun stapler staple "$APP_PATH"

echo "Notarization complete!"
```

### Step 6: Size Optimization

Strip unnecessary resources:

```bash
# Remove debug symbols
strip -x "FocusDragon.app/Contents/MacOS/FocusDragon"

# Remove unused architectures (if not universal)
# lipo -remove x86_64 -output FocusDragon FocusDragon

# Optimize images
find FocusDragon.app -name "*.png" -exec pngcrush -ow {} \\;

# Remove localization files (if not needed)
rm -rf FocusDragon.app/Contents/Resources/*.lproj

echo "App size optimized"
```

## Testing Criteria

### Test 1: Build Success
1. Run `./build-release.sh`
2. **Expected:** No errors
3. **Expected:** App in build/Release/

### Test 2: Code Signing
1. Run `codesign -vvv --deep --strict FocusDragon.app`
2. **Expected:** "valid on disk" and "satisfies its Designated Requirement"

### Test 3: Gatekeeper
1. Run `spctl -a -vvv FocusDragon.app`
2. **Expected:** "accepted"

### Test 4: Notarization
1. Run `./notarize.sh`
2. **Expected:** "Package Approved"
3. **Expected:** Stapling successful

### Test 5: Universal Binary
1. Run `lipo -info FocusDragon.app/Contents/MacOS/FocusDragon`
2. **Expected:** "arm64 x86_64"

### Test 6: App Launch
1. Copy app to /Applications
2. Double-click to launch
3. **Expected:** No Gatekeeper warnings
4. **Expected:** App launches normally

## Deliverables

✅ Release build configuration
✅ Code signing setup
✅ Hardened runtime enabled
✅ Entitlements configured
✅ Build script
✅ Notarization script
✅ Size optimization

## Security Considerations

1. **Hardened runtime** - Protection against code injection
2. **Code signing** - Verify app integrity
3. **Notarization** - Apple approval
4. **Entitlements** - Minimal permissions

## Performance Notes

- Release builds 30-40% faster than debug
- Binary size: ~10-15MB (optimized)
- Launch time: <1 second

## Known Requirements

- Apple Developer account ($99/year)
- Developer ID certificate
- App-specific password for notarization
- macOS 11+ for building

## Success Criteria

- Clean build with no warnings
- Valid code signature
- Gatekeeper approval
- Notarization successful
- Universal binary (Intel + Apple Silicon)
- App runs on fresh macOS install

## Estimated Time

**3-4 hours** (including certificate setup)

## Next Steps

Move to [7.2-dmg-creation.md](./7.2-dmg-creation.md) for creating distributable DMG.
