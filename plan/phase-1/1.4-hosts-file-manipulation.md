# 1.4 Hosts File Manipulation

**Objective:** Implement the core logic to modify `/etc/hosts` for DNS-level website blocking.

## Technical Requirements

- **Location:** `/etc/hosts`
- **Permissions:** Root/administrator required
- **Format:** `0.0.0.0 domain.com`
- **Marker blocks:** Use comments to identify FocusDragon entries

## Hosts File Marker Format

```
#### FocusDragon Block Start ####
0.0.0.0 youtube.com
0.0.0.0 www.youtube.com
0.0.0.0 facebook.com
0.0.0.0 www.facebook.com
#### FocusDragon Block End ####
```

## Implementation Steps

### Step 1: Create HostsFileManager Service

Create `Services/HostsFileManager.swift`:

```swift
import Foundation

class HostsFileManager {
    static let shared = HostsFileManager()

    private let hostsPath = "/etc/hosts"
    private let startMarker = "#### FocusDragon Block Start ####"
    private let endMarker = "#### FocusDragon Block End ####"

    private init() {}

    // MARK: - Public Methods

    func applyBlock(domains: [String]) throws {
        guard !domains.isEmpty else {
            try removeBlock()
            return
        }

        let hostsContent = try readHostsFile()
        let cleanedContent = removeExistingBlock(from: hostsContent)
        let blockSection = generateBlockSection(for: domains)
        let updatedContent = cleanedContent + "\n" + blockSection

        try writeHostsFile(content: updatedContent)
        try flushDNSCache()
    }

    func removeBlock() throws {
        let hostsContent = try readHostsFile()
        let cleanedContent = removeExistingBlock(from: hostsContent)
        try writeHostsFile(content: cleanedContent)
        try flushDNSCache()
    }

    // MARK: - Private Methods

    private func readHostsFile() throws -> String {
        return try String(contentsOfFile: hostsPath, encoding: .utf8)
    }

    private func writeHostsFile(content: String) throws {
        // This requires root privileges
        // For Phase 1, we'll use a shell script with sudo
        let tempFile = "/tmp/focusdragon_hosts_temp"
        try content.write(toFile: tempFile, atomically: true, encoding: .utf8)

        let script = """
        #!/bin/bash
        sudo cp "\(tempFile)" "\(hostsPath)"
        rm "\(tempFile)"
        """

        try runShellScript(script)
    }

    private func removeExistingBlock(from content: String) -> String {
        guard let startRange = content.range(of: startMarker),
              let endRange = content.range(of: endMarker) else {
            return content
        }

        var cleaned = content
        let blockRange = startRange.lowerBound..<endRange.upperBound
        cleaned.removeSubrange(blockRange)

        // Remove extra newlines
        cleaned = cleaned.trimmingCharacters(in: .whitespacesAndNewlines)

        return cleaned
    }

    private func generateBlockSection(for domains: [String]) -> String {
        var entries: [String] = [startMarker]

        for domain in domains {
            let cleaned = domain.lowercased().trimmingCharacters(in: .whitespaces)
            entries.append("0.0.0.0 \(cleaned)")

            // Also block www variant
            if !cleaned.hasPrefix("www.") {
                entries.append("0.0.0.0 www.\(cleaned)")
            }
        }

        entries.append(endMarker)
        return entries.joined(separator: "\n")
    }

    private func flushDNSCache() throws {
        let task = Process()
        task.launchPath = "/usr/bin/sudo"
        task.arguments = ["dscacheutil", "-flushcache"]

        try task.run()
        task.waitUntilExit()
    }

    private func runShellScript(_ script: String) throws {
        let tempScript = "/tmp/focusdragon_script.sh"
        try script.write(toFile: tempScript, atomically: true, encoding: .utf8)

        let task = Process()
        task.launchPath = "/bin/bash"
        task.arguments = [tempScript]

        let pipe = Pipe()
        task.standardError = pipe

        try task.run()
        task.waitUntilExit()

        if task.terminationStatus != 0 {
            let errorData = pipe.fileHandleForReading.readDataToEndOfFile()
            let errorString = String(data: errorData, encoding: .utf8) ?? "Unknown error"
            throw NSError(
                domain: "HostsFileManager",
                code: Int(task.terminationStatus),
                userInfo: [NSLocalizedDescriptionKey: errorString]
            )
        }

        try FileManager.default.removeItem(atPath: tempScript)
    }
}
```

### Step 2: Request Administrator Privileges

For Phase 1, we'll use a simple approach with `sudo`. Create a helper method:

```swift
extension HostsFileManager {
    func requestAdminPrivileges() -> Bool {
        // In Phase 1, we'll use osascript to prompt for sudo
        let script = """
        do shell script "echo 'FocusDragon requesting admin access'" with administrator privileges
        """

        let task = Process()
        task.launchPath = "/usr/bin/osascript"
        task.arguments = ["-e", script]

        do {
            try task.run()
            task.waitUntilExit()
            return task.terminationStatus == 0
        } catch {
            return false
        }
    }
}
```

### Step 3: Integrate with UI

Update `Views/MainView.swift` to connect the toggle:

```swift
private func toggleBlocking() {
    if manager.isBlocking {
        // Stop blocking
        do {
            try HostsFileManager.shared.removeBlock()
            manager.isBlocking = false
        } catch {
            showError(error)
        }
    } else {
        // Start blocking
        let domains = manager.blockedItems
            .filter { $0.isEnabled }
            .map { $0.domain }

        do {
            // Request admin first
            guard HostsFileManager.shared.requestAdminPrivileges() else {
                showError(NSError(domain: "FocusDragon", code: 1,
                                 userInfo: [NSLocalizedDescriptionKey: "Admin privileges required"]))
                return
            }

            try HostsFileManager.shared.applyBlock(domains: domains)
            manager.isBlocking = true
        } catch {
            showError(error)
        }
    }
}

private func showError(_ error: Error) {
    let alert = NSAlert()
    alert.messageText = "Error"
    alert.informativeText = error.localizedDescription
    alert.alertStyle = .warning
    alert.runModal()
}
```

## Permissions Required

- **Administrator/Root access** to modify `/etc/hosts`
- macOS will prompt user with password dialog via `osascript`

## Security Considerations

1. **Input sanitization:** Only allow valid domain names
2. **Marker protection:** Never overwrite non-FocusDragon entries
3. **Backup:** Consider backing up original hosts file
4. **Validation:** Verify domains match pattern before adding

### Add Domain Validation

```swift
extension String {
    var isValidDomain: Bool {
        let domainPattern = "^([a-zA-Z0-9]([a-zA-Z0-9\\-]{0,61}[a-zA-Z0-9])?\\.)+[a-zA-Z]{2,}$"
        let regex = try? NSRegularExpression(pattern: domainPattern)
        let range = NSRange(location: 0, length: self.utf16.count)
        return regex?.firstMatch(in: self, range: range) != nil
    }
}
```

Use in `BlockListManager`:

```swift
func addDomain(_ domain: String) {
    let cleaned = domain.lowercased().trimmingCharacters(in: .whitespaces)
    guard cleaned.isValidDomain else { return }

    let item = BlockItem(domain: cleaned)
    blockedItems.append(item)
}
```

## Deliverables

- Working hosts file modification logic
- Administrator privilege request
- DNS cache flushing
- Error handling
- Domain validation

## Testing Criteria

✅ Adding `youtube.com` to block list and starting block makes YouTube inaccessible in Safari
✅ Stopping block restores YouTube access
✅ `/etc/hosts` contains FocusDragon markers when blocking
✅ Removing block cleans up markers completely
✅ DNS cache is flushed (changes take effect immediately)
✅ Invalid domains are rejected

## Testing Steps

1. Add `youtube.com` to block list
2. Click "Start Block"
3. Enter admin password when prompted
4. Open Safari and try to visit `youtube.com` → should fail
5. Open Terminal: `cat /etc/hosts` → should see FocusDragon block
6. Click "Stop Block"
7. Refresh Safari → YouTube should work
8. Check `/etc/hosts` → FocusDragon block should be removed

## Potential Issues

- **Permission denied:** Ensure admin password is correct
- **DNS cache not flushing:** Try `sudo killall -HUP mDNSResponder` as alternative
- **Changes not taking effect:** Some browsers cache DNS, try using `ping youtube.com` to verify
- **Hosts file corruption:** Always backup before modifying

## Success Criteria

- YouTube (or other test site) is completely inaccessible when blocked
- Block can be toggled on/off reliably
- No errors or crashes
- Hosts file remains valid after operations

## Estimated Time

2-3 hours
