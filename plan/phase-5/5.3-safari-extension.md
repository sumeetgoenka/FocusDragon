# 5.3 Safari App Extension

**Objective:** Create Safari App Extension using Xcode with native macOS integration.

## Overview

Safari extensions on macOS require Xcode and are bundled with the main app. Use Safari App Extension (not Safari Web Extension) for deeper integration.

## Implementation Steps

### Step 1: Add Safari Extension Target in Xcode

1. Open FocusDragon.xcodeproj
2. File → New → Target
3. Select "Safari Extension"
4. Name: "FocusDragonSafariExtension"
5. Language: Swift

### Step 2: Safari Extension Handler

Create `SafariExtensionHandler.swift`:

```swift
import SafariServices

class SafariExtensionHandler: SFSafariExtensionHandler {
    private var blockedDomains: Set<String> = []
    private var isBlocking: Bool = false

    override init() {
        super.init()
        loadBlockedDomains()

        // Observe changes from main app
        NotificationCenter.default.addObserver(
            self,
            selector: #selector(blockListUpdated),
            name: NSNotification.Name("BlockListUpdated"),
            object: nil
        )
    }

    @objc private func blockListUpdated(_ notification: Notification) {
        loadBlockedDomains()
    }

    private func loadBlockedDomains() {
        // Load from shared UserDefaults
        let sharedDefaults = UserDefaults(suiteName: "group.com.focusdragon.shared")
        let domains = sharedDefaults?.array(forKey: "blockedDomains") as? [String] ?? []
        isBlocking = sharedDefaults?.bool(forKey: "isBlocking") ?? false

        blockedDomains = Set(domains)
    }

    override func validateToolbarItem(
        in window: SFSafariWindow,
        validationHandler: @escaping ((Bool, String) -> Void)
    ) {
        validationHandler(true, "")
    }

    override func popoverViewController() -> SFSafariExtensionViewController {
        return SafariExtensionViewController.shared
    }

    override func page(
        _ page: SFSafariPage,
        willNavigateTo url: URL?
    ) {
        guard isBlocking,
              let url = url,
              let host = url.host else {
            return
        }

        if shouldBlockDomain(host) {
            // Block the navigation
            page.getPropertiesWithCompletionHandler { properties in
                if let activeURL = properties?.url {
                    // Redirect to blocked page
                    page.navigate(to: self.blockedPageURL())
                }
            }
        }
    }

    private func shouldBlockDomain(_ host: String) -> Bool {
        let cleanHost = host.lowercased()

        // Check exact match
        if blockedDomains.contains(cleanHost) {
            return true
        }

        // Check without www
        if cleanHost.hasPrefix("www.") {
            let withoutWWW = String(cleanHost.dropFirst(4))
            if blockedDomains.contains(withoutWWW) {
                return true
            }
        }

        // Check parent domains
        for domain in blockedDomains {
            if cleanHost.hasSuffix(domain) {
                return true
            }
        }

        return false
    }

    private func blockedPageURL() -> URL {
        return Bundle.main.url(
            forResource: "blocked",
            withExtension: "html",
            subdirectory: "FocusDragonSafariExtension.appex"
        )!
    }
}
```

### Step 3: Popup View Controller

Create `SafariExtensionViewController.swift`:

```swift
import SafariServices

class SafariExtensionViewController: SFSafariExtensionViewController {
    static let shared: SafariExtensionViewController = {
        let vc = SafariExtensionViewController()
        return vc
    }()

    @IBOutlet weak var statusLabel: NSTextField!
    @IBOutlet weak var blockedListView: NSTableView!
    @IBOutlet weak var openAppButton: NSButton!

    override func viewDidLoad() {
        super.viewDidLoad()
        preferredContentSize = NSSize(width: 300, height: 400)
        updateUI()
    }

    private func updateUI() {
        let sharedDefaults = UserDefaults(suiteName: "group.com.focusdragon.shared")
        let domains = sharedDefaults?.array(forKey: "blockedDomains") as? [String] ?? []
        let isBlocking = sharedDefaults?.bool(forKey: "isBlocking") ?? false

        if isBlocking && !domains.isEmpty {
            statusLabel.stringValue = "Blocking \\(domains.count) site(s)"
        } else {
            statusLabel.stringValue = "No blocking active"
        }

        blockedListView.reloadData()
    }

    @IBAction func openMainApp(_ sender: Any) {
        NSWorkspace.shared.launchApplication("FocusDragon")
    }
}
```

### Step 4: Content Blocker (Alternative Approach)

Safari also supports Content Blocker extensions which are more efficient:

Create content blocker target and rules:

```json
[
  {
    "action": {
      "type": "block"
    },
    "trigger": {
      "url-filter": ".*youtube\\.com.*",
      "resource-type": ["document"]
    }
  }
]
```

Generate rules dynamically:

```swift
func generateContentBlockerRules(domains: [String]) -> [[String: Any]] {
    var rules: [[String: Any]] = []

    for domain in domains {
        let escapedDomain = domain.replacingOccurrences(of: ".", with: "\\\\.")

        rules.append([
            "action": ["type": "block"],
            "trigger": [
                "url-filter": ".*\\(escapedDomain).*",
                "resource-type": ["document"]
            ]
        ])
    }

    return rules
}
```

### Step 5: App Group for Shared Data

1. Enable App Groups in both targets
2. Group ID: `group.com.focusdragon.shared`
3. Share data via UserDefaults:

```swift
// Main app - write
let sharedDefaults = UserDefaults(suiteName: "group.com.focusdragon.shared")
sharedDefaults?.set(blockedDomains, forKey: "blockedDomains")
sharedDefaults?.set(isBlocking, forKey: "isBlocking")

// Extension - read
let sharedDefaults = UserDefaults(suiteName: "group.com.focusdragon.shared")
let domains = sharedDefaults?.array(forKey: "blockedDomains") as? [String] ?? []
```

### Step 6: Enable Safari Extension

Users must manually enable Safari extension:

```swift
func openSafariExtensionPreferences() {
    SFSafariExtensionManager.getStateOfSafariExtension(
        withIdentifier: "com.focusdragon.FocusDragonSafariExtension"
    ) { state, error in
        guard let state = state, !state.isEnabled else {
            return
        }

        // Open Safari Extensions preferences
        SFSafariApplication.showPreferencesForExtension(
            withIdentifier: "com.focusdragon.FocusDragonSafariExtension"
        ) { error in
            if let error = error {
                print("Error opening preferences: \\(error)")
            }
        }
    }
}
```

## Testing Criteria

### Test 1: Extension Installation
1. Build app with Safari extension
2. Open Safari preferences
3. **Expected:** FocusDragon extension listed

### Test 2: Extension Enabling
1. Enable extension in Safari
2. **Expected:** Toolbar icon appears

### Test 3: Website Blocking
1. Block youtube.com
2. Navigate in Safari
3. **Expected:** Blocked or redirected

### Test 4: Shared Data
1. Update block list in main app
2. **Expected:** Safari extension updates immediately

## Deliverables

✅ Safari App Extension target
✅ Extension handler
✅ Content blocker (optional)
✅ App Group sharing
✅ Popup UI
✅ Enable extension flow

## Known Limitations

- Users must manually enable
- Cannot force enable via code
- Sandbox restrictions apply
- Content blockers limited to 50,000 rules

## Estimated Time

**4-5 hours**
