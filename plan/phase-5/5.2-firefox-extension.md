# 5.2 Firefox Extension

**Objective:** Create Firefox WebExtensions API extension with webRequest blocking.

## Overview

Firefox extension uses webRequest API for blocking. Similar structure to Chrome but with Firefox-specific APIs and manifest format.

## Key Differences from Chrome

- Uses `webRequest.onBeforeRequest` instead of declarativeNetRequest
- Native messaging host configuration different
- Manifest V2 (Firefox doesn't fully support V3 yet)
- Permission handling slightly different

## Implementation Steps

### Step 1: Firefox Manifest

Create `manifest.json`:

```json
{
  "manifest_version": 2,
  "name": "FocusDragon",
  "version": "1.0.0",
  "description": "Website blocker for deep focus",
  "icons": {
    "48": "icons/icon48.png",
    "96": "icons/icon96.png"
  },
  "permissions": [
    "webRequest",
    "webRequestBlocking",
    "<all_urls>",
    "storage",
    "nativeMessaging",
    "tabs"
  ],
  "background": {
    "scripts": ["background.js"]
  },
  "browser_action": {
    "default_popup": "popup/popup.html",
    "default_icon": {
      "48": "icons/icon48.png"
    }
  },
  "browser_specific_settings": {
    "gecko": {
      "id": "focusdragon@focusdragon.com",
      "strict_min_version": "91.0"
    }
  }
}
```

### Step 2: Background Script with webRequest

Create `background.js`:

```javascript
const NATIVE_APP_NAME = "com.focusdragon.nativehost";
let blockedDomains = [];
let isBlocking = false;
let nativePort = null;

// Connect to native host
function connectNative() {
  try {
    nativePort = browser.runtime.connectNative(NATIVE_APP_NAME);

    nativePort.onMessage.addListener(handleNativeMessage);

    nativePort.onDisconnect.addListener(() => {
      console.log("Native host disconnected");
      nativePort = null;
      setTimeout(connectNative, 5000);
    });

    nativePort.postMessage({ type: "getBlockedDomains" });
  } catch (error) {
    console.error("Native connection failed:", error);
  }
}

function handleNativeMessage(message) {
  switch (message.type) {
    case "updateBlockedDomains":
      blockedDomains = message.domains || [];
      isBlocking = message.isBlocking || false;
      updateWebRequestListener();
      updateIcon();
      break;
  }
}

// webRequest blocking
function updateWebRequestListener() {
  // Remove existing listener
  if (browser.webRequest.onBeforeRequest.hasListener(blockRequest)) {
    browser.webRequest.onBeforeRequest.removeListener(blockRequest);
  }

  // Add listener if blocking active
  if (isBlocking && blockedDomains.length > 0) {
    const patterns = generateUrlPatterns(blockedDomains);

    browser.webRequest.onBeforeRequest.addListener(
      blockRequest,
      { urls: patterns, types: ["main_frame"] },
      ["blocking"]
    );
  }
}

function blockRequest(details) {
  return { redirectUrl: browser.runtime.getURL("blocked.html") };
}

function generateUrlPatterns(domains) {
  const patterns = [];

  for (const domain of domains) {
    patterns.push(`*://${domain}/*`);
    patterns.push(`*://www.${domain}/*`);
    patterns.push(`*://*.${domain}/*`);
  }

  return patterns;
}

function updateIcon() {
  const iconPath = isBlocking ? "icons/icon-active" : "icons/icon";

  browser.browserAction.setIcon({
    path: {
      48: `${iconPath}48.png`,
      96: `${iconPath}96.png`,
    },
  });

  browser.browserAction.setBadgeText({
    text: isBlocking ? "ON" : "",
  });

  browser.browserAction.setBadgeBackgroundColor({
    color: isBlocking ? "#FF0000" : "#808080",
  });
}

// Initialize
connectNative();

browser.runtime.onStartup.addListener(() => {
  connectNative();
});
```

### Step 3: Native Messaging Host for Firefox

Firefox requires different native messaging host file location.

Create `install-firefox-host.sh`:

```bash
#!/bin/bash

# Install Firefox native messaging host

FIREFOX_NATIVE_DIR="$HOME/Library/Application Support/Mozilla/NativeMessagingHosts"
mkdir -p "$FIREFOX_NATIVE_DIR"

cat > "$FIREFOX_NATIVE_DIR/com.focusdragon.nativehost.json" << 'EOF'
{
  "name": "com.focusdragon.nativehost",
  "description": "FocusDragon Native Messaging Host",
  "path": "/Applications/FocusDragon.app/Contents/MacOS/FocusDragonNativeHost",
  "type": "stdio",
  "allowed_extensions": ["focusdragon@focusdragon.com"]
}
EOF

echo "Firefox native messaging host installed"
```

## Popup & Blocked Page

Reuse same HTML/CSS from Chrome extension (cross-browser compatible).

## Testing Criteria

### Test 1: Extension Installation
1. Load extension in Firefox
2. **Expected:** No errors in about:debugging

### Test 2: webRequest Blocking
1. Block youtube.com
2. Navigate to site
3. **Expected:** Blocked via webRequest redirect

### Test 3: Native Messaging
1. Check browser console
2. **Expected:** Connection successful

## Deliverables

✅ Firefox manifest
✅ webRequest blocking
✅ Native messaging for Firefox
✅ Installation script
✅ Cross-browser UI

## Performance Notes

- webRequest has slight overhead vs declarativeNetRequest
- Still <1% CPU usage
- Blocking happens before page load

## Estimated Time

**2-3 hours** (reuses Chrome UI)
