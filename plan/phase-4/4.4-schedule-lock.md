# 4.4 Schedule Lock Implementation

**Objective:** Implement time-based automatic blocking that activates during specified times and days.

## Overview

Schedule lock automatically activates blocking during configured time windows (e.g., "Every weekday 9 AM - 5 PM"). Users cannot disable blocking during scheduled periods.

## Implementation Steps

### Step 1: Schedule Data Models

Create `Models/ScheduleLock.swift`:

```swift
import Foundation

struct ScheduleRule: Identifiable, Codable, Equatable {
    let id: UUID
    var name: String
    var startTime: DateComponents // Hour and minute
    var endTime: DateComponents
    var days: Set<Weekday>
    var isEnabled: Bool

    init(
        id: UUID = UUID(),
        name: String = "New Schedule",
        startTime: DateComponents,
        endTime: DateComponents,
        days: Set<Weekday>,
        isEnabled: Bool = true
    ) {
        self.id = id
        self.name = name
        self.startTime = startTime
        self.endTime = endTime
        self.days = days
        self.isEnabled = isEnabled
    }

    func isActiveNow() -> Bool {
        guard isEnabled else { return false }

        let now = Date()
        let calendar = Calendar.current
        let weekday = Weekday(from: calendar.component(.weekday, from: now))

        // Check if today is included
        guard days.contains(weekday) else { return false }

        // Get current time components
        let currentHour = calendar.component(.hour, from: now)
        let currentMinute = calendar.component(.minute, from: now)

        let currentMinutes = currentHour * 60 + currentMinute
        let startMinutes = (startTime.hour ?? 0) * 60 + (startTime.minute ?? 0)
        let endMinutes = (endTime.hour ?? 0) * 60 + (endTime.minute ?? 0)

        // Handle overnight schedules
        if endMinutes < startMinutes {
            // Schedule crosses midnight
            return currentMinutes >= startMinutes || currentMinutes < endMinutes
        } else {
            return currentMinutes >= startMinutes && currentMinutes < endMinutes
        }
    }

    var formattedTimeRange: String {
        let formatter = DateFormatter()
        formatter.timeStyle = .short

        let startDate = Calendar.current.date(from: startTime) ?? Date()
        let endDate = Calendar.current.date(from: endTime) ?? Date()

        return "\(formatter.string(from: startDate)) - \(formatter.string(from: endDate))"
    }

    var formattedDays: String {
        if days.count == 7 {
            return "Every day"
        } else if days == Weekday.weekdays {
            return "Weekdays"
        } else if days == Weekday.weekends {
            return "Weekends"
        } else {
            return days.sorted().map { $0.shortName }.joined(separator: ", ")
        }
    }
}

enum Weekday: Int, Codable, CaseIterable, Comparable {
    case sunday = 1
    case monday = 2
    case tuesday = 3
    case wednesday = 4
    case thursday = 5
    case friday = 6
    case saturday = 7

    init(from calendarWeekday: Int) {
        self = Weekday(rawValue: calendarWeekday) ?? .sunday
    }

    var name: String {
        switch self {
        case .sunday: return "Sunday"
        case .monday: return "Monday"
        case .tuesday: return "Tuesday"
        case .wednesday: return "Wednesday"
        case .thursday: return "Thursday"
        case .friday: return "Friday"
        case .saturday: return "Saturday"
        }
    }

    var shortName: String {
        return String(name.prefix(3))
    }

    static func < (lhs: Weekday, rhs: Weekday) -> Bool {
        lhs.rawValue < rhs.rawValue
    }

    static let weekdays: Set<Weekday> = [.monday, .tuesday, .wednesday, .thursday, .friday]
    static let weekends: Set<Weekday> = [.saturday, .sunday]
    static let allDays: Set<Weekday> = Set(Weekday.allCases)
}
```

### Step 2: Schedule Lock Controller

Create `Services/ScheduleLockController.swift`:

```swift
import Foundation
import Combine

class ScheduleLockController: ObservableObject {
    static let shared = ScheduleLockController()

    @Published var schedules: [ScheduleRule] = []
    @Published var isActive: Bool = false
    @Published var activeSchedule: ScheduleRule?
    @Published var nextActivation: Date?

    private var timer: Timer?
    private let userDefaults = UserDefaults.standard
    private let schedulesKey = "focusDragon.schedules"

    private init() {
        loadSchedules()
        startMonitoring()
    }

    // MARK: - Schedule Management

    func addSchedule(_ schedule: ScheduleRule) {
        schedules.append(schedule)
        saveSchedules()
        checkSchedules()
    }

    func updateSchedule(_ schedule: ScheduleRule) {
        if let index = schedules.firstIndex(where: { $0.id == schedule.id }) {
            schedules[index] = schedule
            saveSchedules()
            checkSchedules()
        }
    }

    func removeSchedule(_ schedule: ScheduleRule) {
        schedules.removeAll { $0.id == schedule.id }
        saveSchedules()
        checkSchedules()
    }

    func toggleSchedule(_ schedule: ScheduleRule) {
        if let index = schedules.firstIndex(where: { $0.id == schedule.id }) {
            schedules[index].isEnabled.toggle()
            saveSchedules()
            checkSchedules()
        }
    }

    // MARK: - Monitoring

    private func startMonitoring() {
        // Check every minute
        timer = Timer.scheduledTimer(withTimeInterval: 60, repeats: true) { [weak self] _ in
            self?.checkSchedules()
        }

        // Also check immediately
        checkSchedules()
    }

    private func checkSchedules() {
        let activeSchedules = schedules.filter { $0.isActiveNow() }

        if let active = activeSchedules.first {
            // Schedule is active
            if !isActive || activeSchedule?.id != active.id {
                activateSchedule(active)
            }
        } else {
            // No active schedule
            if isActive {
                deactivateSchedule()
            }
        }

        calculateNextActivation()
    }

    private func activateSchedule(_ schedule: ScheduleRule) {
        isActive = true
        activeSchedule = schedule

        // Notify to start blocking
        NotificationCenter.default.post(
            name: .scheduleLockActivated,
            object: schedule
        )

        NotificationHelper.shared.showScheduleActivated(schedule: schedule)
    }

    private func deactivateSchedule() {
        isActive = false
        activeSchedule = nil

        // Notify to stop blocking
        NotificationCenter.default.post(
            name: .scheduleLockDeactivated,
            object: nil
        )

        NotificationHelper.shared.showScheduleDeactivated()
    }

    private func calculateNextActivation() {
        guard !schedules.isEmpty else {
            nextActivation = nil
            return
        }

        let now = Date()
        let calendar = Calendar.current
        var nearestDate: Date?

        for schedule in schedules.filter({ $0.isEnabled }) {
            // Check next 7 days
            for dayOffset in 0..<7 {
                guard let targetDate = calendar.date(byAdding: .day, value: dayOffset, to: now) else {
                    continue
                }

                let weekday = Weekday(from: calendar.component(.weekday, from: targetDate))

                if schedule.days.contains(weekday) {
                    var components = calendar.dateComponents([.year, .month, .day], from: targetDate)
                    components.hour = schedule.startTime.hour
                    components.minute = schedule.startTime.minute

                    if let activationDate = calendar.date(from: components),
                       activationDate > now {
                        if nearestDate == nil || activationDate < nearestDate! {
                            nearestDate = activationDate
                        }
                    }
                }
            }
        }

        nextActivation = nearestDate
    }

    // MARK: - Preset Schedules

    func createWorkHoursSchedule() -> ScheduleRule {
        var startTime = DateComponents()
        startTime.hour = 9
        startTime.minute = 0

        var endTime = DateComponents()
        endTime.hour = 17
        endTime.minute = 0

        return ScheduleRule(
            name: "Work Hours",
            startTime: startTime,
            endTime: endTime,
            days: Weekday.weekdays
        )
    }

    func createEveningSchedule() -> ScheduleRule {
        var startTime = DateComponents()
        startTime.hour = 18
        startTime.minute = 0

        var endTime = DateComponents()
        endTime.hour = 22
        endTime.minute = 0

        return ScheduleRule(
            name: "Evening Focus",
            startTime: startTime,
            endTime: endTime,
            days: Weekday.allDays
        )
    }

    func createStudySchedule() -> ScheduleRule {
        var startTime = DateComponents()
        startTime.hour = 14
        startTime.minute = 0

        var endTime = DateComponents()
        endTime.hour = 18
        endTime.minute = 0

        return ScheduleRule(
            name: "Study Time",
            startTime: startTime,
            endTime: endTime,
            days: Weekday.weekdays
        )
    }

    // MARK: - Persistence

    private func saveSchedules() {
        if let encoded = try? JSONEncoder().encode(schedules) {
            userDefaults.set(encoded, forKey: schedulesKey)
        }
    }

    private func loadSchedules() {
        if let data = userDefaults.data(forKey: schedulesKey),
           let decoded = try? JSONDecoder().decode([ScheduleRule].self, from: data) {
            schedules = decoded
        }
    }
}

// MARK: - Notifications

extension Notification.Name {
    static let scheduleLockActivated = Notification.Name("scheduleLockActivated")
    static let scheduleLockDeactivated = Notification.Name("scheduleLockDeactivated")
}
```

### Step 3: Schedule Lock UI

Create `Views/ScheduleLockView.swift`:

```swift
import SwiftUI

struct ScheduleLockView: View {
    @StateObject private var controller = ScheduleLockController.shared
    @State private var showingAddSchedule = false

    var body: some View {
        VStack(spacing: 20) {
            headerSection

            if controller.isActive, let active = controller.activeSchedule {
                activeScheduleCard(active)
            }

            if controller.nextActivation != nil {
                nextActivationCard
            }

            schedulesList

            addScheduleButton
        }
        .padding()
        .sheet(isPresented: $showingAddSchedule) {
            ScheduleEditorView(schedule: nil)
        }
    }

    private var headerSection: some View {
        HStack {
            VStack(alignment: .leading) {
                Text("Schedule Lock")
                    .font(.title2)
                    .fontWeight(.semibold)

                Text("Automatic blocking during specific times")
                    .font(.subheadline)
                    .foregroundColor(.secondary)
            }

            Spacer()

            if controller.isActive {
                HStack {
                    Circle()
                        .fill(Color.green)
                        .frame(width: 8, height: 8)
                    Text("Active")
                        .font(.caption)
                        .foregroundColor(.green)
                }
            }
        }
    }

    private func activeScheduleCard(_ schedule: ScheduleRule) -> some View {
        VStack(alignment: .leading, spacing: 10) {
            HStack {
                Image(systemName: "clock.fill")
                    .foregroundColor(.green)
                Text("Currently Active")
                    .font(.headline)
                    .foregroundColor(.green)
            }

            VStack(alignment: .leading, spacing: 5) {
                Text(schedule.name)
                    .font(.title3)
                    .fontWeight(.semibold)

                Text(schedule.formattedTimeRange)
                    .font(.subheadline)
                    .foregroundColor(.secondary)

                Text(schedule.formattedDays)
                    .font(.caption)
                    .foregroundColor(.secondary)
            }
        }
        .padding()
        .frame(maxWidth: .infinity, alignment: .leading)
        .background(Color.green.opacity(0.1))
        .cornerRadius(8)
    }

    private var nextActivationCard: some View {
        Group {
            if let next = controller.nextActivation {
                HStack {
                    Image(systemName: "calendar.badge.clock")
                        .foregroundColor(.blue)

                    VStack(alignment: .leading) {
                        Text("Next Activation")
                            .font(.caption)
                            .foregroundColor(.secondary)

                        Text(formatDate(next))
                            .font(.subheadline)
                            .fontWeight(.medium)
                    }

                    Spacer()
                }
                .padding()
                .background(Color.blue.opacity(0.1))
                .cornerRadius(8)
            }
        }
    }

    private var schedulesList: some View {
        VStack(spacing: 10) {
            if controller.schedules.isEmpty {
                emptyState
            } else {
                ForEach(controller.schedules) { schedule in
                    ScheduleRow(schedule: schedule)
                }
            }
        }
    }

    private var emptyState: some View {
        VStack(spacing: 15) {
            Image(systemName: "calendar.badge.plus")
                .font(.system(size: 50))
                .foregroundColor(.gray)

            Text("No Schedules")
                .font(.headline)
                .foregroundColor(.secondary)

            Text("Create a schedule to automatically activate blocking")
                .font(.subheadline)
                .foregroundColor(.secondary)
                .multilineTextAlignment(.center)
        }
        .padding(.vertical, 30)
    }

    private var addScheduleButton: some View {
        Menu {
            Button("Custom Schedule") {
                showingAddSchedule = true
            }

            Divider()

            Button("Work Hours (9 AM - 5 PM)") {
                controller.addSchedule(controller.createWorkHoursSchedule())
            }

            Button("Evening Focus (6 PM - 10 PM)") {
                controller.addSchedule(controller.createEveningSchedule())
            }

            Button("Study Time (2 PM - 6 PM)") {
                controller.addSchedule(controller.createStudySchedule())
            }
        } label: {
            Label("Add Schedule", systemImage: "plus.circle.fill")
                .frame(maxWidth: .infinity)
        }
        .buttonStyle(.borderedProminent)
    }

    private func formatDate(_ date: Date) -> String {
        let formatter = RelativeDateTimeFormatter()
        formatter.unitsStyle = .full
        return formatter.localizedString(for: date, relativeTo: Date())
    }
}

struct ScheduleRow: View {
    let schedule: ScheduleRule
    @StateObject private var controller = ScheduleLockController.shared

    var body: some View {
        HStack {
            VStack(alignment: .leading, spacing: 5) {
                Text(schedule.name)
                    .font(.headline)

                Text(schedule.formattedTimeRange)
                    .font(.subheadline)
                    .foregroundColor(.secondary)

                Text(schedule.formattedDays)
                    .font(.caption)
                    .foregroundColor(.secondary)
            }

            Spacer()

            Toggle("", isOn: Binding(
                get: { schedule.isEnabled },
                set: { _ in controller.toggleSchedule(schedule) }
            ))
            .labelsHidden()
        }
        .padding()
        .background(Color(.controlBackgroundColor))
        .cornerRadius(8)
    }
}

struct ScheduleEditorView: View {
    let schedule: ScheduleRule?
    @Environment(\.dismiss) private var dismiss
    @StateObject private var controller = ScheduleLockController.shared

    @State private var name: String = ""
    @State private var startHour: Int = 9
    @State private var startMinute: Int = 0
    @State private var endHour: Int = 17
    @State private var endMinute: Int = 0
    @State private var selectedDays: Set<Weekday> = Weekday.weekdays

    var body: some View {
        VStack(spacing: 20) {
            Text("Configure Schedule")
                .font(.title2)
                .fontWeight(.semibold)

            TextField("Schedule Name", text: $name)
                .textFieldStyle(.roundedBorder)

            VStack(alignment: .leading) {
                Text("Start Time")
                    .font(.subheadline)
                    .foregroundColor(.secondary)

                HStack {
                    Picker("Hour", selection: $startHour) {
                        ForEach(0..<24) { hour in
                            Text(String(format: "%02d", hour)).tag(hour)
                        }
                    }
                    .pickerStyle(.wheel)
                    .frame(width: 80)

                    Text(":")

                    Picker("Minute", selection: $startMinute) {
                        ForEach(0..<60) { minute in
                            Text(String(format: "%02d", minute)).tag(minute)
                        }
                    }
                    .pickerStyle(.wheel)
                    .frame(width: 80)
                }
            }

            VStack(alignment: .leading) {
                Text("End Time")
                    .font(.subheadline)
                    .foregroundColor(.secondary)

                HStack {
                    Picker("Hour", selection: $endHour) {
                        ForEach(0..<24) { hour in
                            Text(String(format: "%02d", hour)).tag(hour)
                        }
                    }
                    .pickerStyle(.wheel)
                    .frame(width: 80)

                    Text(":")

                    Picker("Minute", selection: $endMinute) {
                        ForEach(0..<60) { minute in
                            Text(String(format: "%02d", minute)).tag(minute)
                        }
                    }
                    .pickerStyle(.wheel)
                    .frame(width: 80)
                }
            }

            VStack(alignment: .leading) {
                Text("Days")
                    .font(.subheadline)
                    .foregroundColor(.secondary)

                LazyVGrid(columns: [GridItem(.flexible()), GridItem(.flexible()), GridItem(.flexible())]) {
                    ForEach(Weekday.allCases, id: \.self) { day in
                        Toggle(day.shortName, isOn: Binding(
                            get: { selectedDays.contains(day) },
                            set: { isOn in
                                if isOn {
                                    selectedDays.insert(day)
                                } else {
                                    selectedDays.remove(day)
                                }
                            }
                        ))
                        .toggleStyle(.button)
                    }
                }
            }

            Spacer()

            HStack {
                Button("Cancel") {
                    dismiss()
                }
                .buttonStyle(.bordered)

                Spacer()

                Button("Save") {
                    saveSchedule()
                    dismiss()
                }
                .buttonStyle(.borderedProminent)
                .disabled(name.isEmpty || selectedDays.isEmpty)
            }
        }
        .padding()
        .frame(width: 400, height: 600)
    }

    private func saveSchedule() {
        var startTime = DateComponents()
        startTime.hour = startHour
        startTime.minute = startMinute

        var endTime = DateComponents()
        endTime.hour = endHour
        endTime.minute = endMinute

        let newSchedule = ScheduleRule(
            name: name,
            startTime: startTime,
            endTime: endTime,
            days: selectedDays
        )

        controller.addSchedule(newSchedule)
    }
}
```

## Testing Criteria

### Test 1: Schedule Creation
1. Click "Add Schedule"
2. Set "Work Hours" (9 AM - 5 PM, Weekdays)
3. **Expected:** Schedule appears in list

### Test 2: Schedule Activation
1. Create schedule for current time
2. **Expected:** Schedule activates immediately
3. **Expected:** Blocking starts automatically
4. **Expected:** Cannot stop blocking

### Test 3: Schedule Deactivation
1. Wait for schedule to end
2. **Expected:** Deactivates automatically
3. **Expected:** Can now stop blocking

### Test 4: Multiple Schedules
1. Create 3 different schedules
2. **Expected:** Only one can be active at a time
3. **Expected:** Next activation shows earliest upcoming

### Test 5: Preset Schedules
1. Select "Work Hours" preset
2. **Expected:** Pre-configured for 9 AM - 5 PM weekdays

### Test 6: Day Selection
1. Create schedule for weekends only
2. On Saturday: **Expected:** Activates
3. On Monday: **Expected:** Inactive

### Test 7: Overnight Schedule
1. Create schedule 10 PM - 2 AM
2. **Expected:** Crosses midnight correctly
3. **Expected:** Deactivates at 2 AM

## Deliverables

✅ Schedule data models
✅ Schedule lock controller
✅ Schedule UI with editor
✅ Preset schedules
✅ Day selection
✅ Time range picker
✅ Active schedule indicator
✅ Next activation display
✅ Persistence

## Estimated Time

**3-4 hours**
