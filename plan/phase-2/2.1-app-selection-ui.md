# 2.1 Application Selection UI

**Objective:** Add UI to select and manage applications for blocking.

## Overview

Users need to be able to:
- Browse and select applications from their Mac
- See a list of blocked applications
- Remove applications from the block list
- Toggle individual apps on/off

## Implementation Steps

### Step 1: Update BlockItem Model

Modify `Models/BlockItem.swift` to support both websites and apps:

```swift
import Foundation

enum BlockType: String, Codable {
    case website
    case application
}

struct BlockItem: Identifiable, Codable {
    let id: UUID
    var type: BlockType
    var domain: String? // For websites
    var appName: String? // For applications
    var bundleIdentifier: String? // For applications
    var appIconPath: String? // Path to app icon
    var isEnabled: Bool

    init(id: UUID = UUID(), domain: String) {
        self.id = id
        self.type = .website
        self.domain = domain
        self.isEnabled = true
    }

    init(id: UUID = UUID(), appName: String, bundleIdentifier: String, iconPath: String? = nil) {
        self.id = id
        self.type = .application
        self.appName = appName
        self.bundleIdentifier = bundleIdentifier
        self.appIconPath = iconPath
        self.isEnabled = true
    }

    var displayName: String {
        switch type {
        case .website:
            return domain ?? "Unknown"
        case .application:
            return appName ?? "Unknown App"
        }
    }
}
```

### Step 2: Create App Selector Service

Create `Services/AppSelector.swift`:

```swift
import Foundation
import AppKit

class AppSelector {
    static let shared = AppSelector()

    private init() {}

    func selectApplication(completion: @escaping (BlockItem?) -> Void) {
        let panel = NSOpenPanel()
        panel.allowsMultipleSelection = false
        panel.canChooseDirectories = false
        panel.canChooseFiles = true
        panel.allowedContentTypes = [.application]
        panel.directoryURL = URL(fileURLWithPath: "/Applications")
        panel.message = "Select an application to block"

        panel.begin { response in
            guard response == .OK, let url = panel.url else {
                completion(nil)
                return
            }

            let item = self.createBlockItem(from: url)
            completion(item)
        }
    }

    private func createBlockItem(from url: URL) -> BlockItem? {
        guard let bundle = Bundle(url: url),
              let bundleIdentifier = bundle.bundleIdentifier else {
            return nil
        }

        let appName = url.deletingPathExtension().lastPathComponent
        let iconPath = extractIconPath(from: bundle)

        return BlockItem(
            appName: appName,
            bundleIdentifier: bundleIdentifier,
            iconPath: iconPath
        )
    }

    private func extractIconPath(from bundle: Bundle) -> String? {
        // Try to get app icon
        if let iconFile = bundle.object(forInfoDictionaryKey: "CFBundleIconFile") as? String {
            var iconPath = bundle.bundlePath + "/Contents/Resources/" + iconFile
            if !iconFile.hasSuffix(".icns") {
                iconPath += ".icns"
            }
            if FileManager.default.fileExists(atPath: iconPath) {
                return iconPath
            }
        }
        return nil
    }

    func getInstalledApplications() -> [BlockItem] {
        var apps: [BlockItem] = []

        let appDirs = [
            "/Applications",
            "/System/Applications",
            FileManager.default.homeDirectoryForCurrentUser.appendingPathComponent("Applications").path
        ]

        for dir in appDirs {
            guard let contents = try? FileManager.default.contentsOfDirectory(atPath: dir) else {
                continue
            }

            for file in contents where file.hasSuffix(".app") {
                let appURL = URL(fileURLWithPath: dir).appendingPathComponent(file)
                if let item = createBlockItem(from: appURL) {
                    apps.append(item)
                }
            }
        }

        return apps.sorted { $0.displayName < $1.displayName }
    }
}
```

### Step 3: Update BlockListManager

Add methods for managing apps in `Services/BlockListManager.swift`:

```swift
func addApplication(_ app: BlockItem) {
    guard app.type == .application else { return }

    // Check for duplicates
    if blockedItems.contains(where: {
        $0.type == .application && $0.bundleIdentifier == app.bundleIdentifier
    }) {
        return
    }

    blockedItems.append(app)
    saveState()
}

func getWebsites() -> [BlockItem] {
    blockedItems.filter { $0.type == .website }
}

func getApplications() -> [BlockItem] {
    blockedItems.filter { $0.type == .application }
}
```

### Step 4: Create Enhanced Block List View

Update `Views/BlockListView.swift`:

```swift
import SwiftUI

struct BlockListView: View {
    @ObservedObject var manager: BlockListManager
    @State private var selectedTab = 0
    @State private var newDomain = ""
    @State private var showingAppPicker = false

    var body: some View {
        VStack(spacing: 0) {
            // Tab selector
            Picker("Type", selection: $selectedTab) {
                Text("Websites").tag(0)
                Text("Applications").tag(1)
            }
            .pickerStyle(.segmented)
            .padding()

            if selectedTab == 0 {
                websitesView
            } else {
                applicationsView
            }
        }
    }

    private var websitesView: some View {
        VStack {
            // Add website input
            HStack {
                TextField("Enter domain (e.g., youtube.com)", text: $newDomain)
                    .textFieldStyle(.roundedBorder)

                Button("Add") {
                    guard !newDomain.isEmpty else { return }
                    manager.addDomain(newDomain)
                    newDomain = ""
                }
                .buttonStyle(.borderedProminent)
            }
            .padding(.horizontal)

            // Websites list
            List {
                ForEach(manager.getWebsites()) { item in
                    HStack {
                        Image(systemName: "globe")
                            .foregroundColor(.blue)
                        Text(item.displayName)
                        Spacer()
                        Toggle("", isOn: binding(for: item))
                    }
                }
                .onDelete { offsets in
                    deleteItems(at: offsets, from: manager.getWebsites())
                }
            }
        }
    }

    private var applicationsView: some View {
        VStack {
            // Add application button
            HStack {
                Button(action: selectApplication) {
                    Label("Add Application", systemImage: "plus.app")
                }
                .buttonStyle(.borderedProminent)

                Spacer()

                Button(action: showAppBrowser) {
                    Label("Browse Apps", systemImage: "list.bullet")
                }
            }
            .padding(.horizontal)

            // Applications list
            List {
                ForEach(manager.getApplications()) { item in
                    HStack {
                        // App icon
                        if let iconPath = item.appIconPath,
                           let image = NSImage(contentsOfFile: iconPath) {
                            Image(nsImage: image)
                                .resizable()
                                .frame(width: 32, height: 32)
                        } else {
                            Image(systemName: "app")
                                .frame(width: 32, height: 32)
                                .foregroundColor(.gray)
                        }

                        VStack(alignment: .leading) {
                            Text(item.displayName)
                                .font(.body)
                            if let bundleId = item.bundleIdentifier {
                                Text(bundleId)
                                    .font(.caption)
                                    .foregroundColor(.secondary)
                            }
                        }

                        Spacer()

                        Toggle("", isOn: binding(for: item))
                    }
                    .padding(.vertical, 4)
                }
                .onDelete { offsets in
                    deleteItems(at: offsets, from: manager.getApplications())
                }
            }
        }
        .sheet(isPresented: $showingAppPicker) {
            AppBrowserView(manager: manager, isPresented: $showingAppPicker)
        }
    }

    private func binding(for item: BlockItem) -> Binding<Bool> {
        Binding(
            get: { item.isEnabled },
            set: { _ in manager.toggleDomain(id: item.id) }
        )
    }

    private func deleteItems(at offsets: IndexSet, from items: [BlockItem]) {
        let idsToDelete = offsets.map { items[$0].id }
        manager.blockedItems.removeAll { idsToDelete.contains($0.id) }
        manager.saveState()
    }

    private func selectApplication() {
        AppSelector.shared.selectApplication { item in
            guard let item = item else { return }
            manager.addApplication(item)
        }
    }

    private func showAppBrowser() {
        showingAppPicker = true
    }
}
```

### Step 5: Create App Browser View

Create `Views/AppBrowserView.swift`:

```swift
import SwiftUI

struct AppBrowserView: View {
    @ObservedObject var manager: BlockListManager
    @Binding var isPresented: Bool
    @State private var apps: [BlockItem] = []
    @State private var searchText = ""
    @State private var isLoading = true

    var filteredApps: [BlockItem] {
        if searchText.isEmpty {
            return apps
        }
        return apps.filter { $0.displayName.localizedCaseInsensitiveContains(searchText) }
    }

    var body: some View {
        VStack {
            HStack {
                Text("Select Applications to Block")
                    .font(.headline)
                Spacer()
                Button("Done") {
                    isPresented = false
                }
            }
            .padding()

            // Search bar
            TextField("Search applications...", text: $searchText)
                .textFieldStyle(.roundedBorder)
                .padding(.horizontal)

            if isLoading {
                ProgressView("Loading applications...")
                    .padding()
            } else {
                List(filteredApps) { app in
                    HStack {
                        if let iconPath = app.appIconPath,
                           let image = NSImage(contentsOfFile: iconPath) {
                            Image(nsImage: image)
                                .resizable()
                                .frame(width: 32, height: 32)
                        } else {
                            Image(systemName: "app")
                                .frame(width: 32, height: 32)
                        }

                        VStack(alignment: .leading) {
                            Text(app.displayName)
                            if let bundleId = app.bundleIdentifier {
                                Text(bundleId)
                                    .font(.caption)
                                    .foregroundColor(.secondary)
                            }
                        }

                        Spacer()

                        if isAppBlocked(app) {
                            Image(systemName: "checkmark.circle.fill")
                                .foregroundColor(.green)
                        } else {
                            Button("Add") {
                                manager.addApplication(app)
                            }
                            .buttonStyle(.bordered)
                        }
                    }
                    .padding(.vertical, 4)
                }
            }
        }
        .frame(width: 600, height: 500)
        .onAppear {
            loadApplications()
        }
    }

    private func loadApplications() {
        Task {
            let installedApps = await Task.detached {
                AppSelector.shared.getInstalledApplications()
            }.value

            await MainActor.run {
                apps = installedApps
                isLoading = false
            }
        }
    }

    private func isAppBlocked(_ app: BlockItem) -> Bool {
        manager.blockedItems.contains { $0.bundleIdentifier == app.bundleIdentifier }
    }
}
```

### Step 6: Update Main View

Integrate the new block list view into `Views/MainView.swift`:

```swift
var body: some View {
    VStack(spacing: 20) {
        Text("FocusDragon")
            .font(.largeTitle)
            .fontWeight(.bold)

        // Block list (now supports both websites and apps)
        BlockListView(manager: manager)
            .frame(minHeight: 300)

        // Status and controls
        HStack {
            Circle()
                .fill(manager.isBlocking ? Color.green : Color.gray)
                .frame(width: 12, height: 12)
            Text(manager.isBlocking ? "Blocking Active" : "Not Blocking")
                .font(.caption)
                .foregroundColor(.secondary)
        }

        HStack(spacing: 20) {
            Button(manager.isBlocking ? "Stop Block" : "Start Block") {
                toggleBlocking()
            }
            .buttonStyle(.borderedProminent)
            .tint(manager.isBlocking ? .red : .green)
            .disabled(isProcessing || manager.blockedItems.isEmpty)
        }
        .padding()
    }
    .frame(minWidth: 600, minHeight: 500)
    .padding()
}
```

## Deliverables

✅ UI to add applications via file picker
✅ UI to browse all installed applications
✅ List view showing blocked apps with icons
✅ Separate tabs for websites vs applications
✅ Search functionality in app browser
✅ Toggle to enable/disable individual apps

## Testing Criteria

### Test 1: Add Application via Picker
1. Click "Add Application"
2. Select an app (e.g., Steam)
3. **Expected:** App appears in list with icon

### Test 2: Browse Applications
1. Click "Browse Apps"
2. **Expected:** Modal shows all installed apps
3. Search for "Safari"
4. **Expected:** List filters to Safari
5. Click "Add" on an app
6. **Expected:** App added to block list

### Test 3: App Icons
1. Add several apps
2. **Expected:** Each app shows correct icon

### Test 4: Duplicate Prevention
1. Add Steam
2. Try to add Steam again
3. **Expected:** Second add is ignored

### Test 5: Persistence
1. Add multiple apps
2. Quit and relaunch
3. **Expected:** Apps still in list with icons

## Success Criteria

- Can select and add applications easily
- App icons display correctly
- Search and browse functionality works
- No duplicates allowed
- State persists between launches

## Estimated Time

2-3 hours
