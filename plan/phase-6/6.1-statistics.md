# 6.1 Statistics & Analytics

**Objective:** Track and visualize usage statistics including blocked time, sessions, streaks, and productivity metrics.

## Overview

Comprehensive statistics system tracking blocking sessions, websites blocked, apps terminated, and productivity streaks with charts and insights.

## Data Models

### Step 1: Statistics Models

Create `Models/Statistics.swift`:

```swift
import Foundation

struct FocusSession: Codable, Identifiable {
    let id: UUID
    let startTime: Date
    var endTime: Date?
    var duration: TimeInterval { (endTime ?? Date()).timeIntervalSince(startTime) }
    var blockedDomains: [String]
    var blockedApps: [String]
    var interruptionAttempts: Int = 0
    var lockType: LockType?

    var isActive: Bool { endTime == nil }
}

struct DailyStats: Codable {
    let date: Date
    var totalFocusTime: TimeInterval = 0
    var sessionsCount: Int = 0
    var domainsBlocked: Set<String> = []
    var appsBlocked: Set<String> = []
    var interruptionAttempts: Int = 0
}

struct ProductivityStreak: Codable {
    var currentStreak: Int = 0
    var longestStreak: Int = 0
    var lastSessionDate: Date?

    mutating func recordSession() {
        let today = Calendar.current.startOfDay(for: Date())

        if let last = lastSessionDate {
            let lastDay = Calendar.current.startOfDay(for: last)
            let daysBetween = Calendar.current.dateComponents([.day], from: lastDay, to: today).day ?? 0

            if daysBetween == 0 {
                // Same day, keep streak
            } else if daysBetween == 1 {
                // Next day, increment
                currentStreak += 1
                longestStreak = max(longestStreak, currentStreak)
            } else {
                // Streak broken
                currentStreak = 1
            }
        } else {
            currentStreak = 1
        }

        lastSessionDate = Date()
    }

    mutating func reset() {
        currentStreak = 0
    }
}

struct FocusStatistics: Codable {
    var sessions: [FocusSession] = []
    var dailyStats: [String: DailyStats] = [:]
    var streak: ProductivityStreak = ProductivityStreak()
    var totalFocusTime: TimeInterval = 0
    var totalSessions: Int = 0
    var totalInterruptions: Int = 0

    var averageSessionDuration: TimeInterval {
        guard totalSessions > 0 else { return 0 }
        return totalFocusTime / TimeInterval(totalSessions)
    }

    var mostBlockedDomains: [(String, Int)] {
        var counts: [String: Int] = [:]
        for session in sessions {
            for domain in session.blockedDomains {
                counts[domain, default: 0] += 1
            }
        }
        return counts.sorted { $0.value > $1.value }.prefix(10).map { ($0.key, $0.value) }
    }
}
```

### Step 2: Statistics Manager

Create `Services/StatisticsManager.swift`:

```swift
import Foundation
import Combine

class StatisticsManager: ObservableObject {
    static let shared = StatisticsManager()

    @Published var statistics = FocusStatistics()
    @Published var currentSession: FocusSession?

    private let storageKey = "focusStatistics"
    private var timer: Timer?

    private init() {
        loadStatistics()
        startPeriodicSave()
    }

    // MARK: - Session Management

    func startSession(domains: [String], apps: [String], lockType: LockType?) {
        let session = FocusSession(
            id: UUID(),
            startTime: Date(),
            blockedDomains: domains,
            blockedApps: apps,
            lockType: lockType
        )

        currentSession = session
        statistics.sessions.append(session)
        statistics.streak.recordSession()

        NotificationCenter.default.post(name: .sessionStarted, object: session)
    }

    func endSession() {
        guard var session = currentSession else { return }

        session.endTime = Date()

        // Update session in array
        if let index = statistics.sessions.firstIndex(where: { $0.id == session.id }) {
            statistics.sessions[index] = session
        }

        // Update totals
        statistics.totalFocusTime += session.duration
        statistics.totalSessions += 1

        // Update daily stats
        updateDailyStats(for: session)

        currentSession = nil
        saveStatistics()

        NotificationCenter.default.post(name: .sessionEnded, object: session)
    }

    func recordInterruption() {
        currentSession?.interruptionAttempts += 1
        statistics.totalInterruptions += 1
        saveStatistics()
    }

    // MARK: - Daily Stats

    private func updateDailyStats(for session: FocusSession) {
        let dateKey = dayKey(for: session.startTime)

        var dayStats = statistics.dailyStats[dateKey] ?? DailyStats(date: session.startTime)
        dayStats.totalFocusTime += session.duration
        dayStats.sessionsCount += 1
        dayStats.domainsBlocked.formUnion(session.blockedDomains)
        dayStats.appsBlocked.formUnion(session.blockedApps)
        dayStats.interruptionAttempts += session.interruptionAttempts

        statistics.dailyStats[dateKey] = dayStats
    }

    private func dayKey(for date: Date) -> String {
        let formatter = DateFormatter()
        formatter.dateFormat = "yyyy-MM-dd"
        return formatter.string(from: date)
    }

    func getStatsForLast(_ days: Int) -> [DailyStats] {
        let calendar = Calendar.current
        var stats: [DailyStats] = []

        for i in 0..<days {
            guard let date = calendar.date(byAdding: .day, value: -i, to: Date()) else { continue }
            let key = dayKey(for: date)

            if let dayStats = statistics.dailyStats[key] {
                stats.append(dayStats)
            } else {
                stats.append(DailyStats(date: date))
            }
        }

        return stats.reversed()
    }

    // MARK: - Persistence

    private func saveStatistics() {
        if let encoded = try? JSONEncoder().encode(statistics) {
            UserDefaults.standard.set(encoded, forKey: storageKey)
        }
    }

    private func loadStatistics() {
        if let data = UserDefaults.standard.data(forKey: storageKey),
           let decoded = try? JSONDecoder().decode(FocusStatistics.self, from: data) {
            statistics = decoded
        }
    }

    private func startPeriodicSave() {
        timer = Timer.scheduledTimer(withTimeInterval: 60, repeats: true) { [weak self] _ in
            self?.saveStatistics()
        }
    }

    func exportStatistics() -> URL? {
        guard let encoded = try? JSONEncoder().encode(statistics) else { return nil }

        let filename = "focusdragon-stats-\\(Date().timeIntervalSince1970).json"
        let url = FileManager.default.temporaryDirectory.appendingPathComponent(filename)

        try? encoded.write(to: url)
        return url
    }
}

extension Notification.Name {
    static let sessionStarted = Notification.Name("sessionStarted")
    static let sessionEnded = Notification.Name("sessionEnded")
}
```

### Step 3: Statistics View with Charts

Create `Views/StatisticsView.swift`:

```swift
import SwiftUI
import Charts

struct StatisticsView: View {
    @StateObject private var manager = StatisticsManager.shared

    var body: some View {
        ScrollView {
            VStack(spacing: 30) {
                summaryCards
                streakCard
                sessionsChart
                topBlockedList
                exportButton
            }
            .padding()
        }
    }

    private var summaryCards: some View {
        LazyVGrid(columns: [GridItem(.flexible()), GridItem(.flexible())], spacing: 15) {
            StatCard(
                title: "Total Focus Time",
                value: formatDuration(manager.statistics.totalFocusTime),
                icon: "clock.fill",
                color: .blue
            )

            StatCard(
                title: "Sessions",
                value: "\\(manager.statistics.totalSessions)",
                icon: "calendar",
                color: .green
            )

            StatCard(
                title: "Avg Session",
                value: formatDuration(manager.statistics.averageSessionDuration),
                icon: "chart.bar.fill",
                color: .orange
            )

            StatCard(
                title: "Interruptions",
                value: "\\(manager.statistics.totalInterruptions)",
                icon: "exclamationmark.triangle.fill",
                color: .red
            )
        }
    }

    private var streakCard: some View {
        VStack(spacing: 10) {
            HStack {
                Image(systemName: "flame.fill")
                    .foregroundColor(.orange)
                Text("Productivity Streak")
                    .font(.headline)
            }

            HStack(spacing: 40) {
                VStack {
                    Text("\\(manager.statistics.streak.currentStreak)")
                        .font(.system(size: 40, weight: .bold))
                    Text("Current")
                        .font(.caption)
                        .foregroundColor(.secondary)
                }

                VStack {
                    Text("\\(manager.statistics.streak.longestStreak)")
                        .font(.system(size: 40, weight: .bold))
                    Text("Best")
                        .font(.caption)
                        .foregroundColor(.secondary)
                }
            }
        }
        .padding()
        .background(Color(.controlBackgroundColor))
        .cornerRadius(12)
    }

    private var sessionsChart: some View {
        VStack(alignment: .leading) {
            Text("Last 7 Days")
                .font(.headline)

            Chart(manager.getStatsForLast(7)) { stat in
                BarMark(
                    x: .value("Date", stat.date, unit: .day),
                    y: .value("Hours", stat.totalFocusTime / 3600)
                )
                .foregroundStyle(.blue)
            }
            .frame(height: 200)
        }
        .padding()
        .background(Color(.controlBackgroundColor))
        .cornerRadius(12)
    }

    private var topBlockedList: some View {
        VStack(alignment: .leading) {
            Text("Most Blocked Sites")
                .font(.headline)

            ForEach(manager.statistics.mostBlockedDomains.prefix(5), id: \\.0) { domain, count in
                HStack {
                    Text(domain)
                    Spacer()
                    Text("\\(count)x")
                        .foregroundColor(.secondary)
                }
                .padding(.vertical, 5)
            }
        }
        .padding()
        .background(Color(.controlBackgroundColor))
        .cornerRadius(12)
    }

    private var exportButton: some View {
        Button("Export Statistics") {
            if let url = manager.exportStatistics() {
                NSWorkspace.shared.activateFileViewerSelecting([url])
            }
        }
        .buttonStyle(.bordered)
    }

    private func formatDuration(_ interval: TimeInterval) -> String {
        let hours = Int(interval) / 3600
        let minutes = (Int(interval) % 3600) / 60

        if hours > 0 {
            return "\\(hours)h \\(minutes)m"
        } else {
            return "\\(minutes)m"
        }
    }
}

struct StatCard: View {
    let title: String
    let value: String
    let icon: String
    let color: Color

    var body: some View {
        VStack(alignment: .leading, spacing: 10) {
            HStack {
                Image(systemName: icon)
                    .foregroundColor(color)
                Text(title)
                    .font(.caption)
                    .foregroundColor(.secondary)
            }

            Text(value)
                .font(.system(size: 24, weight: .bold))
        }
        .frame(maxWidth: .infinity, alignment: .leading)
        .padding()
        .background(Color(.controlBackgroundColor))
        .cornerRadius(12)
    }
}
```

## Testing Criteria

✅ Session tracking accurate
✅ Daily stats accumulate correctly
✅ Streak logic works (consecutive days)
✅ Charts display data
✅ Export functionality
✅ Performance with 1000+ sessions

## Estimated Time

**4-5 hours**
